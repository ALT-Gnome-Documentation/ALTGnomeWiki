# etersoft-build-utils

etersoft-build-utils - набор утилит для сборки RPM пакетов созданный компанией Etersoft

## Подготовка локальной сборочницы

Первым делом, что необходимо сделать, это установить необходимые пакеты из репозитория, для этого открываем терминал и выполняем установку.

```
su -
apt-get update
apt-get install etersoft-build-utils hasher
```

После установки пакетов необходимо добавить локального пользователя в hasher, от него будет выполняться сборка

Добавление пользователя происходит под root пользователем, пользователем с повышенными правами..

:::info
Для понимания сразу оговорюсь

***$*** - выполнение команды от обычного пользователя

***#*** - выполнения команды от пользователя root
:::

выполняем команду добавления _локального пользователя_ и после выходим из root

```
# hasher-useradd USER
# exit
```

USER = _локальный_ пользователь сборочницы

Далее настраиваем файл ~/.rpmmacros по следующему образцу

```
%_topdir    %homedir/RPM
#%_tmppath  %homedir/tmp
%_gpg_path      %homedir/.gnupg
%_gpg_name      Boris Yumankulov <boria138@altlinux.org>
%packager       Boris Yumankulov <boria138@altlinux.org>
```

***Почту оставляем именно altlinux.org даже если вы ещё не дошли до join 2.3 (ВАЖНО)***

Для сборки некоторых пакетов hasher может понадобиться доступ к /proc чтобы смонтировать её добавить

```
allowed_mountpoints=/proc
```

в /etc/hasher-priv/system и BuildRequires: /proc в спеке пакета

На этом настройка завершена

## Сборка пакетов с использованием утилит из etersoft-build-utils

Если пакет который вы желаете собрать есть в стороннем репозитории (Fedora, Rosa и так далее) вы можете попробовать скачать оттуда src.rpm с помощью rpmgp

Например команда rpmgp -a distrobox выведет это

```
List for fedora-rawhide-e:
    d/distrobox-1.7.2.1-1.fc41.src.rpm

List for rosa-fresh.cr:
    distrobox-1.6.0.1-1.src.rpm
```

Чтобы скачать src.rpm нужно ввести rpmgp -a -d название пакета, в моём случае будет rpmgp -a -d distrobox-1.7.2.1-1.fc41.src.rpm

Далее после того как вы вытащили spec из src.rpm его нужно очистить командой rpmcs, она уберёт {} не используемые в альте, а так же попытается исправить зависимости и макросы

***Команда rpmcs может иногда ошибаться, так что внимательно следите за тем как изменился spec (ВАЖНО)***

После того как наш spec и gear готов можно собирать пакет, первым делом создаём git репозиторий

```
git init
```

Я обычно после этого комичу spec и gear и только потом делаю rpmgs для скачивания исходников, но на этот счёт нет чёткого правила поэтому можете делать как хотите

```
git add .
git commit -m "Initial commit"
rpmgs -f
```

rpmgs сам создаёт changelog вида

```
%changelog
* Tue May 28 2024 Boris Yumankulov <boria138@altlinux.org> 1.7.2.1-alt1
- new version (1.7.2.1) with rpmgs script
```

***При join 4.2 рецензенту может не понравится запись "with rpmgs script" поэтому удаляем её (ВАЖНО)***

Теперь когда готов spec,gear и имеются исходники осталось только собрать пакет через rpmbsh -l (Это L не I)

Если во время сборки произошла ошибка и вам понадобилась пересборка используйте rpmbsh -e, эта команда использует уже созданный chroot не создавая новый что экономит достаточно много времени

Чтобы протестировать собранный пакет в hasher нужно написать rpmbsh -i, эта команда установит пакет в hasher где вы можете его тестировать
